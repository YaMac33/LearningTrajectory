---
date: 2026-02-15
category: awscp
title: "============================================================"
publish: false
---

============================================================
SQS デッドレターキュー（DLQ）を図解で理解する
============================================================

対象サービス：
Amazon Simple Queue Service（SQS）

------------------------------------------------------------
■ まず通常のSQSの流れ
------------------------------------------------------------

Producer
   ↓
[ メインキュー ]
   ↓
Consumer（アプリ）
   ↓
処理成功 → メッセージ削除

図：

送信
  ↓
┌──────────────┐
│   メインキュー  │
└──────────────┘
        ↓
   コンシューマ
        ↓
     成功 → 削除


------------------------------------------------------------
■ 問題が起きた場合
------------------------------------------------------------

コンシューマが処理失敗すると：

・メッセージは削除されない
・Visibility Timeout後に再度キューへ戻る
・再試行される

図：

処理失敗
   ↓
一定時間見えなくなる
   ↓
再びキューへ戻る
   ↓
再処理


------------------------------------------------------------
■ 何度も失敗する場合どうなる？
------------------------------------------------------------

maxReceiveCount（最大受信回数）を超えると：

→ デッドレターキューへ移動

------------------------------------------------------------
■ デッドレターキュー（DLQ）とは？
------------------------------------------------------------

「処理に何度も失敗したメッセージの隔離場所」

図：

            ┌────────────┐
            │ メインキュー │
            └────────────┘
                   ↓
            処理失敗×n回
                   ↓
            ┌────────────┐
            │  デッドレター │
            │     キュー     │
            └────────────┘


------------------------------------------------------------
■ 重要ポイント①
------------------------------------------------------------

DLQは自動削除しない。

→ そこに残り続ける（保持期間まで）

つまり：

「残ったメッセージを定期的に削除することはない」

------------------------------------------------------------
■ 重要ポイント②
------------------------------------------------------------

DLQは「ポーリングされずに残った」メッセージではない。

正確には：

「何度も処理失敗したメッセージ」が移動する。

------------------------------------------------------------
■ なぜ使うのか？
------------------------------------------------------------

理由：

・無限リトライ防止
・正常メッセージへの影響防止
・原因調査用

図：

正常メッセージ  → 通常処理
問題メッセージ  → DLQに隔離

------------------------------------------------------------
■ 実務イメージ
------------------------------------------------------------

例：

JSONフォーマットが壊れているメッセージ

処理アプリ：
  parseエラー
  ↓
  再試行
  ↓
  また失敗
  ↓
  DLQへ移動

→ DLQを見れば原因分析可能

------------------------------------------------------------
■ 全体の流れまとめ図
------------------------------------------------------------

Producer
   ↓
┌──────────────┐
│  メインキュー   │
└──────────────┘
        ↓
   Consumer
        ↓
  ┌──────────────┐
  │ 成功 → 削除     │
  │ 失敗 → 再試行   │
  └──────────────┘
        ↓
  maxReceiveCount超過
        ↓
┌────────────────┐
│ デッドレターキュー │
└────────────────┘


------------------------------------------------------------
■ ポイント整理
------------------------------------------------------------

・DLQは失敗メッセージの隔離先
・自動削除はしない
・maxReceiveCount超過で移動
・デバッグ用途に重要
・正常メッセージへの影響を防ぐ

------------------------------------------------------------
■ 一文まとめ
------------------------------------------------------------

デッドレターキューは、処理に失敗し続けたメッセージを隔離し、
システムの安定性とデバッグを助けるためのキューである。
