<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google tag (fixed) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MQ9ZB4LYWP"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GEN: META（生成時に置換） -->
  <title>Learning Trajectory | インフラの外側とインスタンスの内側</title>
  <meta name="description" content="AWS CloudFormationやSSMを使ったEC2内部管理の効率的な方法について解説します。" />
  <meta name="robots" content="index,follow" />

  <!-- Optional: OGP（不要なら空でOK） -->
  <meta property="og:type" content="article" />
  <meta property="og:title" content="インフラの外側とインスタンスの内側" />
  <meta property="og:description" content="AWS CloudFormationやSSMを使ったEC2内部管理の効率的な方法について解説します。" />
  

  <!-- Assets (article path: docs/<category>/posts/.../index.html) -->
  <link rel="stylesheet" href="../../../assets/styles.css" />

  <!-- 図解用追加スタイル -->
  <style>
    .diagram-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
      padding: 24px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow-x: auto;
    }
    .diagram-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      color: #475569;
      font-size: 0.9em;
    }
    .diagram-layers {
      display: flex;
      justify-content: center;
      gap: 20px;
      align-items: stretch;
      flex-wrap: wrap;
    }
    .layer-box {
      border: 2px dashed #94a3b8;
      border-radius: 8px;
      padding: 16px;
      background: #fff;
      flex: 1;
      min-width: 280px;
      position: relative;
    }
    .layer-box.outer {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .layer-box.inner {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .layer-label {
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
      text-align: center;
    }
    .tool-chip {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
      background: #fff;
      border: 1px solid #cbd5e1;
      color: #334155;
    }
    .flow-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
    .flow-step {
      background: #fff;
      border: 2px solid #6366f1;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      width: 100%;
      max-width: 400px;
    }
    .flow-arrow {
      color: #94a3b8;
      font-size: 1.2em;
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.95em;
    }
    .comparison-table th, .comparison-table td {
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: left;
    }
    .comparison-table th {
      background: #f3f4f6;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">

    <header class="site-header">
      <a href="../../../index.html" class="site-title">Learning Trajectory</a>
    </header>

    <!-- 固定：前後ナビ（JS制御） -->
    <nav class="post-nav">
      <a id="prevPost" class="post-nav__link" href="#" style="display:none;">← 前の記事</a>
      <a id="nextPost" class="post-nav__link" href="#" style="display:none;">次の記事 →</a>
    </nav>

    <main>
      <article class="article-content">

        <header class="article-header">
          <!-- GEN: POST META -->
          <time class="post-meta" datetime="2026-02-03">
            2026.02.03
          </time>

          <!-- GEN: TITLE -->
          <h1 class="article-title"> インフラの外側とインスタンスの内側 </h1>

          <!-- GEN: TAGS -->
          <div class="tags">
            <span class="tag">#EC2</span>
            <span class="tag">#AWS</span>
            <span class="tag">#CloudFormation</span>
            <span class="tag">#運用管理</span>
            <span class="tag">#SSM</span>
          </div>
        </header>

        <!-- GEN: BODY -->
        <p>AWS CloudFormationやSSMを使ったEC2内部管理の効率的な方法について解説します。</p>
<hr>
<p>
  EC2の管理において、「インフラの外側（VPC/EC2/RDS/ALBなど）」と「インスタンスの内側（OS設定・パッケージ・アプリ設定）」は、明確にレイヤーを分けて管理するのが基本です。<br>
  ここを混同すると運用が複雑化し、変更時のリスクが高まります。
</p>

<h2>1. 前提：AWS CloudFormation / CDKは「外側」が主戦場</h2>
<p>
  IaC（Infrastructure as Code）ツールであるCloudFormationやAWS CDKは、基本的に「AWSリソースそのもの」の作成が得意です。
</p>

<!-- 図解：管理レイヤーの分離 -->
<div class="diagram-container">
  <div class="diagram-title">管理レイヤーの境界線</div>
  <div class="diagram-layers">
    <div class="layer-box outer">
      <span class="layer-label" style="color:#1d4ed8;">インフラの外側 (AWSリソース)</span>
      <p style="font-size:0.9em; margin:8px 0;">VPC, SecurityGroup, IAM, ALB, EC2の「枠」</p>
      <div style="margin-top:10px;">
        <span class="tool-chip">CloudFormation</span>
        <span class="tool-chip">AWS CDK</span>
        <span class="tool-chip">Terraform</span>
      </div>
    </div>
    <div class="layer-box inner">
      <span class="layer-label" style="color:#b45309;">インスタンスの内側 (OS/App)</span>
      <p style="font-size:0.9em; margin:8px 0;">ミドルウェア設定, パッケージ更新, アプリ配置</p>
      <div style="margin-top:10px;">
        <span class="tool-chip">UserData</span>
        <span class="tool-chip">SSM</span>
        <span class="tool-chip">Ansible</span>
      </div>
    </div>
  </div>
</div>

<p>
  例外として、EC2内部へ「初回の設定を流し込む」機能（<code>UserData</code> や <code>cfn-init</code>）はありますが、継続的な日々の運用（パッケージ更新など）までCloudFormationで管理しようとすると、スタックの更新に時間がかかり運用が重くなります。
</p>

<h2>2. EC2内部を管理する3つのアプローチ</h2>
<p>実務で採用される代表的な3つのパターンを解説します。</p>

<h3>A) 起動時に一回だけやる（“初期化”）</h3>
<p>
  「サーバーが立ち上がる瞬間にだけ実行する」アプローチです。<br>
  <strong>おすすめ用途</strong>: OS初期設定、最低限のエージェント導入、設定ファイルの雛形作成など
</p>
<ul>
  <li><strong>UserData (cloud-init)</strong>: 最も一般的。シェルスクリプトを記述して渡すだけ。</li>
  <li><strong>cfn-init</strong>: CloudFormationテンプレート内にメタデータとして構成情報を記述できるため、親和性が高い。</li>
</ul>

<h3>B) 起動後も安全に実行したい（“運用・変更”）</h3>
<p>
  ここで登場するのが <strong>AWS Systems Manager (SSM)</strong> です。<br>
  「起動中のサーバーに対して、外から安全に手を加える」ための有力な選択肢です。
</p>
<ul>
  <li><strong>Run Command</strong>: コマンドのリモート実行（SSH不要）。</li>
  <li><strong>State Manager</strong>: 「あるべき状態（Ansibleのような構成管理）」を定義して自動適用。</li>
  <li><strong>Patch Manager</strong>: セキュリティパッチ適用の自動化。</li>
</ul>

<h3>C) “そもそもEC2内部を後からいじらない”設計（推奨）</h3>
<p>
  「イミュータブル（不変）インフラ」の考え方です。実務ではこれが最も堅牢です。
</p>
<ol>
  <li><strong>AMIを焼く</strong>:
    <ul>
      <li>アプリや設定済みのAMI（Amazon Machine Image）を作成しておき、更新時は「サーバーごと入れ替える」方式。</li>
      <li><strong>EC2 Image Builder</strong> や HashiCorp Packer を使用します。</li>
    </ul>
  </li>
  <li><strong>コンテナに寄せる</strong>:
    <ul>
      <li>ECSやEKSを使い、OS設定の管理コスト自体を極小化します。</li>
    </ul>
  </li>
</ol>

<h2>3. 選択の指針（ベストプラクティス）</h2>
<p>「結局どうすればいいの？」と迷った時の判断基準です。</p>

<div class="diagram-container">
  <div class="diagram-title">管理手法の決定フロー</div>
  <div class="flow-chart">
    <div class="flow-step" style="border-color:#94a3b8; background:#f1f5f9;">
      目的は何ですか？
    </div>
    <div class="flow-arrow">↓</div>
    
    <div class="diagram-layers" style="width:100%; gap:10px;">
      <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
        <span style="font-size:0.8em; margin-bottom:4px;">最初のセットアップだけ</span>
        <div class="flow-step" style="background:#dbeafe; border-color:#3b82f6;">UserData / cfn-init</div>
      </div>
      
      <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
        <span style="font-size:0.8em; margin-bottom:4px;">運用でコマンドを当てたい</span>
        <div class="flow-step" style="background:#ffedd5; border-color:#f97316;">Systems Manager (SSM)</div>
      </div>
      
      <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
        <span style="font-size:0.8em; margin-bottom:4px;">更新を安全・確実にする</span>
        <div class="flow-step" style="background:#dcfce7; border-color:#22c55e;">AMI焼き直し / コンテナ</div>
      </div>
    </div>
  </div>
</div>

<h3>よくある誤解</h3>
<ul>
  <li>
    <strong>「CloudFormationだけで全部やりたい」</strong><br>
    できなくはありませんが、OS内部の細かい変更をCFnスタック更新で行うのは、時間がかかりすぎたり、意図しない再作成が発生するリスクがあります。
  </li>
  <li>
    <strong>「CLIで入るならSSM一択？」</strong><br>
    SSMは強力ですが、ベストなのは<strong>「そもそもログインしなくて済む（AMI入れ替えやコンテナ化）」</strong>構成にすることです。
  </li>
</ul>

<h2>まとめ</h2>
<p>
  もし現在の想定が「静的サイト」や「API」なら、EC2を使わない（S3, Lambda, Fargate）構成を検討すべきです。<br>
  逆に「EC2で常駐アプリを動かす」必要があるなら、学習ステップとして以下の順で進めるのがおすすめです。
</p>
<ol>
  <li><strong>UserData</strong> で初期構築を自動化する。</li>
  <li><strong>SSM</strong> で運用中の変更や確認を行う。</li>
  <li>慣れてきたら <strong>EC2 Image Builder</strong> でAMI運用の自動化に挑戦する。</li>
</ol>

        <!-- 問い合わせ（固定・修正版） -->
        <p class="article-contact">
          <a id="contactLink" href="#" target="_blank">✉ お問い合わせ</a>
        </p>

        <!-- GEN: REFERENCES（不要なら空） -->
        

      </article>
    </main>

    <footer class="site-footer">
      <p>&copy; <span id="year"></span> Learning Trajectory. All rights reserved.</p>
    </footer>

  </div>

  <!-- 記事用JS（前後リンク・問い合わせURL） -->
  <script src="../../../assets/post.js"></script>

  <!-- 共通：年表示 -->
  <script>
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  </script>
</body>
</html>